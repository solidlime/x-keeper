services:
  keep-image-saver:
    build:
      context: .
      dockerfile: Dockerfile
      # キャッシュ効率化のためビルドターゲットを明示
      target: runtime

    image: keep-image-saver:latest

    container_name: keep-image-saver

    restart: unless-stopped

    # 環境変数は .env ファイルから読み込む (.env.example を参照)
    env_file:
      - .env

    environment:
      # コンテナ内の Python stdout/stderr を UTF-8 に固定する (ログ文字化け対策)
      PYTHONUTF8: "1"

    # OAuth2 認証フロー用コールバックサーバのポート
    # 初回セットアップ時のみ使用。認証完了後は不要 (ただし常時公開しておいて問題ない)
    # OAUTH_CALLBACK_PORT を変更した場合はホスト側ポートも連動して変わる
    ports:
      - "${OAUTH_CALLBACK_PORT:-8989}:${OAUTH_CALLBACK_PORT:-8989}"

    volumes:
      # .env をマウントすることでセットアップコマンドの書き込みがホストに反映される
      - ./.env:/app/.env
      # data ディレクトリ全体をマウント（認証ファイル・Cookie・画像）
      # NAS の画像保存先をマウントする場合は、適宜パスを変更する。
      # 例: Synology NAS の場合は左辺を /volume1/data に変更
      - ./data:/data

    # ── リソース制限 ────────────────────────────────────────────────────────
    deploy:
      resources:
        limits:
          # Google Keep + Twitter API のポーリングは軽量なため低めに設定
          memory: 256M
        reservations:
          memory: 64M

    # ── ロギング設定 ─────────────────────────────────────────────────────────
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ── Web セットアップサーバー ──────────────────────────────────────────────
  # Google OAuth2 認証情報をブラウザ経由で設定するためのサービス。
  # 通常運用では不要なため profiles: [setup] で分離している。
  #
  # 起動コマンド:
  #   docker compose --profile setup up setup
  # ブラウザで http://localhost:8080 を開いてセットアップを進める。
  # 認証完了後に Ctrl+C でこのサービスを停止し、通常コンテナを起動する:
  #   docker compose up -d
  setup:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime

    image: keep-image-saver:latest

    container_name: keep-image-saver-setup

    command: ["python", "-m", "src.web_setup"]

    profiles:
      - setup

    ports:
      - "8080:8080"

    environment:
      PYTHONUTF8: "1"
      # ローカル HTTP での OAuth2 フローを許可 (セットアップ専用サービスのみ)
      OAUTHLIB_INSECURE_TRANSPORT: "1"

    volumes:
      # .env をマウントして書き込み結果をホストに反映する
      - ./.env:/app/.env

    # リソース制限 (セットアップ専用なので最小限)
    deploy:
      resources:
        limits:
          memory: 128M

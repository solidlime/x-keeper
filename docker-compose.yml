services:
  keep-image-saver:
    build:
      context: .
      dockerfile: Dockerfile
      # キャッシュ効率化のためビルドターゲットを明示
      target: runtime

    image: keep-image-saver:latest

    container_name: keep-image-saver

    restart: unless-stopped

    # 環境変数は .env ファイルから読み込む (.env.example を参照)
    env_file:
      - .env

    environment:
      # コンテナ内の Python stdout/stderr を UTF-8 に固定する (ログ文字化け対策)
      PYTHONUTF8: "1"

    volumes:
      # .env をマウントすることでセットアップコマンドの書き込みがホストに反映される
      - ./.env:/app/.env
      # data ディレクトリ全体をマウント（認証ファイル・Cookie・画像）
      # NAS の画像保存先をマウントする場合は、適宜パスを変更する。
      # 例: Synology NAS の場合は左辺を /volume1/data に変更
      - ./data:/data

    # ── リソース制限 ────────────────────────────────────────────────────────
    deploy:
      resources:
        limits:
          # Google Keep + Twitter API のポーリングは軽量なため低めに設定
          memory: 256M
        reservations:
          memory: 64M

    # ── ロギング設定 ─────────────────────────────────────────────────────────
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ── Web セットアップサーバー ──────────────────────────────────────────────
  # Google OAuth2 認証情報をブラウザ経由で設定するためのサービス。
  # メインサービスと並行して常時起動する。
  # ブラウザで http://localhost:8080 を開いてセットアップを進める。
  setup:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime

    image: keep-image-saver:latest

    container_name: keep-image-saver-setup

    command: ["python", "-m", "src.web_setup"]

    restart: unless-stopped

    env_file:
      - .env

    ports:
      - "${WEB_SETUP_PORT:-8989}:${WEB_SETUP_PORT:-8989}"

    environment:
      PYTHONUTF8: "1"
      # ローカル HTTP での OAuth2 フローを許可 (セットアップ専用サービスのみ)
      OAUTHLIB_INSECURE_TRANSPORT: "1"

    volumes:
      # .env をマウントして書き込み結果をホストに反映する
      - ./.env:/app/.env

    # リソース制限 (セットアップ専用なので最小限)
    deploy:
      resources:
        limits:
          memory: 128M
